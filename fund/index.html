<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>基準価額チャート with インジケーター</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://cdn.jsdelivr.net/npm/babel-standalone@6/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/recharts/umd/Recharts.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    .container { display: flex; gap: 20px; }
    .controls { width: 250px; }
    .chart { flex: 1; }
    textarea { width: 100%; height: 120px; }
    label { display:block; margin:5px 0; }
  </style>
</head>
<body>
  <h2>基準価額チャート + インジケーター</h2>
  <div id="root"></div>

  <script type="text/babel">
    const { useState } = React;
    const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = Recharts;

    function parseCSV(csv) {
      const lines = csv.trim().split(/\n/);
      const headers = lines[0].split(",");
      return lines.slice(1).map(l => {
        const cols = l.split(",");
        return {
          date: cols[0],
          price: parseFloat(cols[1]) || null
        };
      }).filter(d => d.price !== null);
    }

    function SMA(data, period) {
      return data.map((d,i)=>{
        if(i<period-1) return {...d};
        let sum=0;
        for(let j=0;j<period;j++) sum+=data[i-j].price;
        return {...d, sma: sum/period};
      });
    }
    function EMA(data, period) {
      let k = 2/(period+1);
      let emaPrev = data[0]?.price;
      return data.map((d,i)=>{
        if(i===0) return {...d, ema: emaPrev};
        emaPrev = d.price*k + emaPrev*(1-k);
        return {...d, ema: emaPrev};
      });
    }
    function VWAP(data, period) {
      return data.map((d,i)=>{
        if(i<period-1) return {...d};
        let sum=0;
        for(let j=0;j<period;j++) sum+=data[i-j].price*1; // volume=1
        return {...d, vwap: sum/period};
      });
    }
    function RSI(data, period) {
      let gains=0, losses=0;
      const out = [];
      for(let i=1;i<data.length;i++){
        let change = data[i].price - data[i-1].price;
        gains += change>0?change:0;
        losses += change<0?-change:0;
        if(i>=period){
          gains/=period; losses/=period;
          let rs = losses===0?100:gains/losses;
          let rsi = 100 - (100/(1+rs));
          out.push({...data[i], rsi});
        } else {
          out.push({...data[i]});
        }
      }
      return [{...data[0]}, ...out];
    }

    function App(){
      const [csv,setCsv] = useState(`基準日,基準価額(円),分配金再投資基準価額(円),純資産総額(億円),分配金(円)\n2018/07/20,10000,10000,0.10,\n2018/07/23,9995,9995,0.09,\n2018/07/24,10003,10003,0.16,`);
      const [smaOn,setSmaOn]=useState(false);
      const [emaOn,setEmaOn]=useState(false);
      const [vwapOn,setVwapOn]=useState(false);
      const [rsiOn,setRsiOn]=useState(false);
      const [smaP,setSmaP]=useState(5);
      const [emaP,setEmaP]=useState(5);
      const [vwapP,setVwapP]=useState(5);
      const [rsiP,setRsiP]=useState(14);

      let data = parseCSV(csv);
      if(smaOn) data = SMA(data,smaP);
      if(emaOn) data = EMA(data,emaP);
      if(vwapOn) data = VWAP(data,vwapP);
      if(rsiOn) data = RSI(data,rsiP);

      return (
        <div className="container">
          <div className="controls">
            <h4>CSV入力</h4>
            <textarea value={csv} onChange={e=>setCsv(e.target.value)} />
            <h4>インジケーター</h4>
            <label><input type="checkbox" checked={smaOn} onChange={e=>setSmaOn(e.target.checked)} /> SMA
              <input type="number" value={smaP} onChange={e=>setSmaP(+e.target.value)} style={{width:'50px'}} />
            </label>
            <label><input type="checkbox" checked={emaOn} onChange={e=>setEmaOn(e.target.checked)} /> EMA
              <input type="number" value={emaP} onChange={e=>setEmaP(+e.target.value)} style={{width:'50px'}} />
            </label>
            <label><input type="checkbox" checked={vwapOn} onChange={e=>setVwapOn(e.target.checked)} /> VWAP
              <input type="number" value={vwapP} onChange={e=>setVwapP(+e.target.value)} style={{width:'50px'}} />
            </label>
            <label><input type="checkbox" checked={rsiOn} onChange={e=>setRsiOn(e.target.checked)} /> RSI
              <input type="number" value={rsiP} onChange={e=>setRsiP(+e.target.value)} style={{width:'50px'}} />
            </label>
          </div>
          <div className="chart">
            <ResponsiveContainer width="100%" height={400}>
              <LineChart data={data}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis dataKey="date" />
                <YAxis yAxisId="left" />
                <YAxis yAxisId="right" orientation="right" domain={[0,100]} />
                <Tooltip />
                <Legend />
                <Line type="monotone" dataKey="price" stroke="#000" yAxisId="left" name="価格" />
                {smaOn && <Line type="monotone" dataKey="sma" stroke="blue" yAxisId="left" name={`SMA(${smaP})`} />}
                {emaOn && <Line type="monotone" dataKey="ema" stroke="red" yAxisId="left" name={`EMA(${emaP})`} />}
                {vwapOn && <Line type="monotone" dataKey="vwap" stroke="green" yAxisId="left" name={`VWAP(${vwapP})`} />}
                {rsiOn && <Line type="monotone" dataKey="rsi" stroke="purple" yAxisId="right" name={`RSI(${rsiP})`} />}
              </LineChart>
            </ResponsiveContainer>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
  </script>
</body>
</html>
